machine:
  environment:
    NODE_ENV: test
  node:
    version: 6.9.0
  services:
    - docker
general:
  artifacts:
    - ./coverage
dependencies:
  pre:
    - echo $CI_PULL_REQUEST
    - echo $CIRCLE_BRANCH
  override:
    - echo "NOOP"
test:
  override:
    - docker pull node:6.10-slim
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD -e $DOCKER_EMAIL
    - node ./scripts/docker/buildAndPush.js
deployment:
  release:
    tag: /v\d+\.\d+\.\d+.*/
    owner: TrueCar
    commands:
      - docker pull node:6.10-slim
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD -e $DOCKER_EMAIL
      - BRANCH=$CIRCLE_BRANCH npm run publish -- $CIRCLE_TAG
